# 3.6-打卡提醒上线

这是我实现3.6功能“打卡提醒上线”过程中，对AI提出的功能描述需求和问题迭代处理的完整记录。

## 功能描述（本地实现）

检测未打卡的时间，设置弹窗提醒，对内容进行校验，系统将其添加到列表中并记录打卡时间。

打卡有两种方式，第一种是推文的@提醒（即类似twitter的“提到了谁”），第二种是推文的定时发送提醒（即成员必须在一定时间内发布一条动态）。

1. 在发布情侣/家庭空间内的推文时，可以@特定成员阅读推文设置倒计时。被@的成员会在“空间”的底部状态栏收到小红点提示，点进空间后推文会提示谁@了你，并有可选项“已读”（表示接受打卡）和“忽略”（表达拒绝打卡）。没有被@的其他成员“空间”的底部状态栏不会有提示，但是依然能在推文看到谁被@了。倒计时需要以"hh-mm-ss"格式，每秒在推文对应位置更新。如果超过倒计时设定时间，该成员仍然没有打卡，就对该成员发送通知/弹出弹窗提醒。发布者也可以看到成员具体是什么时候查看信息的。

2. 在“空间管理”面板，添加定时打卡设置，指定空间全部或部分成员，在规定时间间隔内发布动态。如果不发布，则发送通知/弹出弹窗提醒。

请先实现以上功能的本地实现和优化（如果当前代码已有部分实现），保证本地android-studio能够正常运行和调试以上功能。

目前应该是暂时先不需要修改./backend后端代码。

## Issues

很多细节处理有问题，请优化：

### 第1轮

1. @提醒：
    1. 被@时确实在“空间”的底部状态栏收到小红点提示了，但需要优化：
        1. 多空间时，应该显示具体是哪个空间的提醒。具体表现为：在“空间”的底部状态栏计数总共的未读提醒数目，点进去后应该在各个空间的列表项上显示各自的未读提醒数目。
        2. 添加“一键标记为已读”功能，方便用户操作。
        3. 优化小红点计数逻辑，尽可能保证每个空间未读消息数正确。
    2. 被@的成员收到的提醒，不应当只显示“提醒了x人查看”，而应当显示“提醒了你和其他x-1人查看”，并且将这条推文高亮和置顶，方便用户查看。
    3. 倒计时结束后，似乎没有立刻进行弹窗通知。
    4. 倒计时结束后，被@的人不应当能够再对该推文进行“已读”操作，否则就失去了打卡的意义。

2. 在“空间管理”面板，添加定时打卡设置，指定空间全部或部分成员，在规定时间间隔内发布动态。如果不发布，则发送通知/弹出弹窗提醒。该功能主要涉及到`app/src/main/java/com/example/hearhome/ui/space/SpaceManageScreen.kt`和`app/src/main/java/com/example/hearhome/utils/CheckInHelper.kt`等文件。目前成员似乎无法收到定时打卡的任何提醒和倒计时，请修复该问题：
    1. 确认定时打卡功能的逻辑是否正确。
    2. 确认成员是否能够收到定时打卡的提醒和倒计时。
    3. 确认成员在规定时间内发布动态后，系统是否正确记录打卡时间。
    4. 确认成员未及时发布动态时，系统是否正确发送通知/弹出弹窗提醒。
    5. 优化定时打卡功能的用户界面，比如在空间列表项上显示定时打卡的状态和剩余时间等。

### 第2轮

1. @提醒：
    1. 允许发送提醒的人发布推文和提醒后，修改倒计时或直接删除提醒后重新设置提醒。
    2. 被@的成员的倒计时结束后如果没有打卡，此时弹窗提醒依然不能立刻出现，不知道为什么，请排查
2. 定时打卡：
    1. 允许空间管理员修改定时打卡的时间间隔。并且注意，定时打卡一旦设置就一直有效、无限循环，直到管理员取消打卡。目前定时打卡似乎只会生效一轮，之后管理员再次访问“空间管理”面板时，定时打卡设置就消失了。
    2. 优化定时打卡的用户界面，比如在空间列表实时展示定时打卡倒计时，在空间详情页显示定时打卡的历史记录和统计数据等。

### 第3轮

1. @提醒：
    1. 发送提醒的人设置倒计时后，倒计时会先显示为一个另外的时间（大概持续2秒），然后才切换到正确的时间。
    2. 发送提醒的人可以修改倒计时，但是被@的成员的倒计时并不会立即更新为新的设置的时间。

2. 定时打卡：
    1. 空间管理员修改定时打卡的时间间隔后，面板里“当前打卡间隔”不会立即更新，而是大概过5秒才更新。另外，修改时间间隔后，系统似乎没有立刻重置所有用户打卡计时器，并应用新的时间间隔，而是依然使用旧的时间间隔。
    
请修改以上问题。

## 后端更新

经过以上多轮迭代以后，打卡上线功能的本地部署基本已经完整实现。现在，请你在理解之前所有修改代码的基础上，阅读`./backend`目录下的代码，完成后端的相应修改，使得打卡提醒功能能够在后端服务器上正常运行，保证最终用户在使用云服务器部署的版本时，打卡提醒功能也能完全正常使用。