# 宠物功能数据库初始化指南

## 1. 执行SQL建表脚本

在MySQL数据库中执行以下SQL语句创建 `space_pets` 表：

```sql
CREATE TABLE IF NOT EXISTS space_pets (
    id INT AUTO_INCREMENT PRIMARY KEY,
    spaceId INT NOT NULL,
    name VARCHAR(128) NOT NULL,
    type VARCHAR(32) NOT NULL DEFAULT 'pet',
    mood TINYINT NOT NULL DEFAULT 50,
    health TINYINT NOT NULL DEFAULT 80,
    energy TINYINT NOT NULL DEFAULT 60,
    hydration TINYINT NOT NULL DEFAULT 60,
    intimacy TINYINT NOT NULL DEFAULT 50,
    updatedAt BIGINT NOT NULL,
    FOREIGN KEY (spaceId) REFERENCES spaces(id) ON DELETE CASCADE
);
```

### 命令行方式：

```bash
# 方式1：直接执行
mysql -u<username> -p<password> <database_name> < sql/create_space_pets_table.sql

# 方式2：登录后执行
mysql -u<username> -p
use <database_name>;
source /path/to/sql/create_space_pets_table.sql;
```

### 图形化工具方式（如Navicat/MySQL Workbench）：
1. 连接到数据库
2. 选择目标数据库
3. 打开SQL编辑器
4. 粘贴并执行上述SQL语句

## 2. 重启Ktor后端服务

建表完成后，重启后端服务以加载新的路由：

```bash
cd d:\lvhome\ktor
./gradlew run
```

或者在IDEA中重新运行Application.kt

## 3. 验证功能

### 后端验证：
```bash
# 测试获取宠物（首次应返回404）
curl http://localhost:8080/space/1/pet

# 测试创建宠物
curl -X POST http://localhost:8080/space/1/pet \
  -H "Content-Type: application/json" \
  -d '{
    "name": "萌宠",
    "type": "pet",
    "attributes": {
      "mood": 50,
      "health": 80,
      "energy": 60,
      "hydration": 60,
      "intimacy": 50
    }
  }'
```

### 前端验证：
1. 编译并运行Android应用
2. 进入任意空间详情页
3. 应该能看到"空间宠物"卡片
4. 点击喂食/浇水/治疗/玩耍按钮测试交互
5. 观察属性条的变化

## 4. 功能说明

### 属性系统（0-100）：
- **心情值**：影响宠物状态，通过玩耍/喂食提升
- **健康值**：低水分/能量会导致下降，治疗可恢复
- **体力值**：玩耍会消耗，喂食可补充
- **水分值**：自然衰减，浇水可补充
- **亲密度**：影响其他属性的增长/衰减系数

### 操作说明：
- **喂食**：+12能量，+6心情（受亲密度加成）
- **浇水**：+14水分，+5健康（受亲密度加成）
- **治疗**：+15健康，+3心情（受亲密度加成）
- **玩耍**：+10心情，-6能量（受亲密度加成）

### 自动衰减：
- 每30分钟自动执行一次tick
- 能量和水分自然下降
- 水分<30或能量<30时健康会下降
- 健康<40时心情会下降
- 亲密度越高，衰减越慢

## 5. 故障排查

### 问题1：看不到宠物卡片
- 检查数据库是否成功创建表
- 确认后端服务已重启
- 查看Android日志是否有网络错误

### 问题2：操作后属性不变
- 检查后端日志，确认请求成功
- 确认前端ViewModel正确同步
- 尝试退出重新进入空间页面刷新数据

### 问题3：定时衰减不工作
- 检查应用是否被系统杀死
- 确认WorkManager权限正常
- 查看WorkManager日志

## 6. 后续扩展建议

- 添加宠物外观选择（猫/狗/植物等）
- 增加成就系统（连续打卡、满值维持等）
- 添加宠物等级和进化系统
- 实现宠物间互动（访问好友空间）
- 增加特殊道具系统
